---
title: "Juvenile Fish Analysis with Tivy"
author: "Hans Ttito"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Juvenile Fish Analysis with Tivy}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 8,
  fig.height = 6,
  warning = FALSE,
  message = FALSE
)
```

```{r setup}
library(Tivy)
library(dplyr)
library(ggplot2)
library(tidyr)
```

## Introduction

Juvenile fish analysis is crucial for fisheries management and stock assessment. This vignette demonstrates how to use Tivy for analyzing juvenile proportions in catches, including length-weight relationships, catch weighting, and visualization of population structure.

## Understanding Juvenile Analysis

### What are Juveniles?

In fisheries science, juveniles are typically defined as fish below a certain size threshold, often related to:
- **Size at first maturity**: Fish that haven't reached reproductive size
- **Legal minimum size**: Fish below legal harvest limits
- **Management targets**: Size classes of special conservation concern

### Length-Weight Relationships

Fish weight estimation uses the allometric relationship: **W = a Ã— L^b**

Where:
- **W** = Weight (grams)
- **L** = Length (cm) 
- **a** = Coefficient (species-specific)
- **b** = Exponent (typically 2.5-3.5)

## Basic Juvenile Analysis

### Setting Up Length Data

```{r eval=FALSE}
# Load and process length frequency data
processed_lengths <- process_length(
  data_length = raw_length_data,
  verbose = TRUE
)

# Examine the structure
head(processed_lengths)

# Check available length classes
length_columns <- find_columns_by_pattern(processed_lengths, pattern = "^[0-9]")
cat("Available length classes:", paste(length_columns[1:10], collapse = ", "), "...\n")
```

### Calculate Juvenile Percentages

```{r eval=FALSE}
# Calculate juvenile percentages by haul
juvenile_results <- summarize_juveniles_by_group(
  data = processed_lengths,
  group_cols = c("fishing_trip_code", "haul_number"),
  length_cols = length_columns,
  juvenile_limit = 12,  # 12 cm threshold
  a = 0.0012,          # Length-weight coefficient
  b = 3.1242,          # Length-weight exponent
  verbose = TRUE
)

# View results
head(juvenile_results)
summary(juvenile_results$perc_juv_number)
summary(juvenile_results$perc_juv_weight)
```

### Understanding the Results

```{r eval=FALSE}
# Compare juvenile percentages by number vs weight
comparison_data <- juvenile_results %>%
  select(fishing_trip_code, haul_number, perc_juv_number, perc_juv_weight) %>%
  pivot_longer(
    cols = c(perc_juv_number, perc_juv_weight),
    names_to = "metric_type", 
    values_to = "percentage"
  ) %>%
  mutate(
    metric_type = recode(metric_type,
      "perc_juv_number" = "By Number",
      "perc_juv_weight" = "By Weight"
    )
  )

# Visualize the comparison
ggplot(comparison_data, aes(x = metric_type, y = percentage, fill = metric_type)) +
  geom_boxplot() +
  geom_jitter(alpha = 0.3, width = 0.2) +
  labs(
    title = "Juvenile Percentage: Number vs Weight",
    x = "Metric Type",
    y = "Juvenile Percentage (%)",
    fill = "Metric"
  ) +
  theme_minimal() +
  theme(legend.position = "none")
```

## Length-Weight Relationships

### Species-Specific Parameters

Different species have different length-weight relationships:

```{r eval=FALSE}
# Common Peruvian species parameters (examples)
species_parameters <- data.frame(
  species = c("Engraulis ringens", "Sardinops sagax", "Trachurus murphyi"),
  common_name = c("Anchoveta", "Sardina", "Jurel"),
  a = c(0.0048, 0.0091, 0.0079),
  b = c(3.067, 3.152, 3.089),
  juvenile_limit = c(12, 15, 20)  # cm
)

print(species_parameters)

# Calculate weights for a range of lengths
lengths <- seq(8, 25, by = 0.5)
weight_examples <- sapply(1:nrow(species_parameters), function(i) {
  calculate_fish_weight(
    length = lengths,
    a = species_parameters$a[i],
    b = species_parameters$b[i]
  )
})

# Create comparison plot
weight_data <- data.frame(
  length = rep(lengths, ncol(weight_examples)),
  weight = as.vector(weight_examples),
  species = rep(species_parameters$common_name, each = length(lengths))
)

ggplot(weight_data, aes(x = length, y = weight, color = species)) +
  geom_line(size = 1.2) +
  labs(
    title = "Length-Weight Relationships by Species",
    x = "Length (cm)",
    y = "Weight (g)",
    color = "Species"
  ) +
  theme_minimal()
```

### Validating Length-Weight Parameters

```{r eval=FALSE}
# Check if parameters are reasonable
validate_lw_params <- function(a, b, length_range = c(8, 30)) {
  lengths <- seq(length_range[1], length_range[2], by = 1)
  weights <- calculate_fish_weight(lengths, a, b)
  
  # Check for reasonable values
  checks <- list(
    a_positive = a > 0,
    b_in_range = b >= 2.5 & b <= 3.5,
    weights_positive = all(weights > 0),
    weight_growth = all(diff(weights) > 0),  # Weights should increase with length
    reasonable_weights = all(weights < 1000)  # < 1kg for small fish
  )
  
  return(checks)
}

# Validate parameters for anchoveta
anchoveta_validation <- validate_lw_params(a = 0.0048, b = 3.067)
print(anchoveta_validation)
```

## Catch Weighting

### Converting Number to Weight

Raw length frequencies represent counts. To get biomass estimates, we need to weight by catch:

```{r eval=FALSE}
# Example: Apply catch weighting to length data
catch_data <- data.frame(
  haul_id = 1:3,
  total_catch_kg = c(150, 200, 180),
  # Length frequencies (8cm, 9cm, 10cm, 11cm, 12cm)
  "8" = c(10, 5, 8),
  "9" = c(25, 12, 20), 
  "10" = c(40, 30, 35),
  "11" = c(30, 25, 28),
  "12" = c(15, 18, 12),
  check.names = FALSE
)

# Apply catch weighting
weighted_data <- apply_catch_weighting(
  data = catch_data,
  length_cols = c("8", "9", "10", "11", "12"),
  catch_col = "total_catch_kg",
  a = 0.0048,  # Anchoveta parameters
  b = 3.067,
  silence_warnings = FALSE
)

# Compare original vs weighted frequencies
original_cols <- c("8", "9", "10", "11", "12")
weighted_cols <- paste0("weighted_", original_cols)

comparison <- weighted_data %>%
  select(haul_id, all_of(original_cols), all_of(weighted_cols)) %>%
  pivot_longer(
    cols = -haul_id,
    names_to = "measure",
    values_to = "frequency"
  ) %>%
  mutate(
    length_class = gsub("weighted_", "", measure),
    type = ifelse(grepl("weighted", measure), "Weighted", "Original")
  )

ggplot(comparison, aes(x = length_class, y = frequency, fill = type)) +
  geom_col(position = "dodge") +
  facet_wrap(~haul_id, labeller = label_both) +
  labs(
    title = "Original vs Catch-Weighted Frequencies",
    x = "Length Class (cm)",
    y = "Frequency",
    fill = "Type"
  ) +
  theme_minimal()
```

### Bulk Processing

```{r eval=FALSE}
# Process multiple hauls with catch weighting
bulk_weighted <- apply_catch_weighting(
  data = large_dataset,
  length_cols = find_columns_by_pattern(large_dataset, pattern = "^[0-9]"),
  catch_col = "total_catch",
  a = 0.0048,
  b = 3.067,
  parallel = TRUE,    # Use parallel processing
  num_cores = 4,      # Number of cores
  silence_warnings = TRUE
)
```

## Temporal and Spatial Patterns

### Juvenile Trends Over Time

```{r eval=FALSE}
# Analyze juvenile trends by date
temporal_data <- processed_data %>%
  mutate(
    date = as.Date(start_date_haul),
    month = lubridate::month(date),
    year = lubridate::year(date)
  )

# Calculate monthly juvenile percentages
monthly_juveniles <- summarize_juveniles_by_group(
  data = temporal_data,
  group_cols = c("year", "month"),
  length_cols = length_columns,
  juvenile_limit = 12
)

# Add date for plotting
monthly_juveniles <- monthly_juveniles %>%
  mutate(date = as.Date(paste(year, month, "01", sep = "-")))

# Plot temporal trends
ggplot(monthly_juveniles, aes(x = date)) +
  geom_line(aes(y = perc_juv_number, color = "By Number"), size = 1) +
  geom_line(aes(y = perc_juv_weight, color = "By Weight"), size = 1) +
  geom_smooth(aes(y = perc_juv_number), method = "loess", se = TRUE, alpha = 0.3) +
  labs(
    title = "Temporal Trends in Juvenile Percentage",
    x = "Date",
    y = "Juvenile Percentage (%)",
    color = "Metric"
  ) +
  theme_minimal() +
  scale_color_manual(values = c("By Number" = "blue", "By Weight" = "red"))
```

### Spatial Patterns of Juveniles

```{r eval=FALSE}
# Analyze juvenile patterns by fishing zone
spatial_juveniles <- temporal_data %>%
  mutate(
    zone = case_when(
      dc < 10 ~ "Nearshore (<10 nm)",
      dc < 30 ~ "Intermediate (10-30 nm)", 
      TRUE ~ "Offshore (>30 nm)"
    )
  )

# Calculate juvenile percentages by zone
zone_juveniles <- summarize_juveniles_by_group(
  data = spatial_juveniles,
  group_cols = "zone",
  length_cols = length_columns,
  juvenile_limit = 12
)

# Visualize spatial patterns
ggplot(zone_juveniles, aes(x = zone)) +
  geom_col(aes(y = perc_juv_number, fill = "By Number"), alpha = 0.7, position = position_dodge()) +
  geom_col(aes(y = perc_juv_weight, fill = "By Weight"), alpha = 0.7, position = position_dodge()) +
  labs(
    title = "Juvenile Percentage by Fishing Zone",
    x = "Distance Zone",
    y = "Juvenile Percentage (%)",
    fill = "Metric"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

## Advanced Juvenile Analysis

### Size Structure Analysis

```{r eval=FALSE}
# Analyze complete size structure
analyze_size_structure <- function(data, length_cols) {
  # Extract length values and frequencies
  length_values <- as.numeric(length_cols)
  
  # Calculate weighted average length
  avg_length <- sapply(1:nrow(data), function(i) {
    frequencies <- as.numeric(data[i, length_cols])
    total_fish <- sum(frequencies, na.rm = TRUE)
    
    if (total_fish > 0) {
      weighted.mean(length_values, frequencies, na.rm = TRUE)
    } else {
      NA_real_
    }
  })
  
  # Calculate length percentiles
  calc_percentile <- function(row_data, percentile) {
    frequencies <- as.numeric(row_data[length_cols])
    total_fish <- sum(frequencies, na.rm = TRUE)
    
    if (total_fish == 0) return(NA_real_)
    
    cumsum_freq <- cumsum(frequencies) / total_fish
    target_idx <- which(cumsum_freq >= percentile / 100)[1]
    
    if (is.na(target_idx)) return(NA_real_)
    return(length_values[target_idx])
  }
  
  # Add metrics to data
  data$avg_length <- avg_length
  data$length_p25 <- apply(data, 1, calc_percentile, percentile = 25)
  data$length_p50 <- apply(data, 1, calc_percentile, percentile = 50)
  data$length_p75 <- apply(data, 1, calc_percentile, percentile = 75)
  
  return(data)
}

# Apply size structure analysis
size_structure <- analyze_size_structure(processed_lengths, length_columns)

# Visualize size structure
ggplot(size_structure, aes(x = avg_length)) +
  geom_histogram(bins = 30, fill = "skyblue", alpha = 0.7) +
  geom_vline(xintercept = 12, color = "red", linetype = "dashed", size = 1) +
  annotate("text", x = 12.5, y = Inf, label = "Juvenile Limit", 
           vjust = 1.5, color = "red", fontface = "bold") +
  labs(
    title = "Distribution of Average Lengths in Catches",
    x = "Average Length (cm)",
    y = "Number of Hauls"
  ) +
  theme_minimal()
```

### Cohort Analysis

```{r eval=FALSE}
# Identify cohorts in length frequency data
identify_cohorts <- function(data, length_cols, min_prominence = 0.1) {
  length_values <- as.numeric(length_cols)
  
  cohorts <- list()
  
  for (i in 1:nrow(data)) {
    frequencies <- as.numeric(data[i, length_cols])
    total_fish <- sum(frequencies, na.rm = TRUE)
    
    if (total_fish > 0) {
      # Smooth frequencies
      smooth_freq <- smooth(frequencies)$y
      
      # Find local maxima (potential cohorts)
      peaks <- which(diff(sign(diff(smooth_freq))) == -2) + 1
      
      # Filter by prominence
      prominent_peaks <- peaks[smooth_freq[peaks] > min_prominence * max(smooth_freq)]
      
      if (length(prominent_peaks) > 0) {
        cohort_lengths <- length_values[prominent_peaks]
        cohort_strengths <- smooth_freq[prominent_peaks]
        
        cohorts[[i]] <- data.frame(
          haul_id = i,
          cohort_length = cohort_lengths,
          cohort_strength = cohort_strengths
        )
      }
    }
  }
  
  if (length(cohorts) > 0) {
    return(do.call(rbind, cohorts))
  } else {
    return(data.frame())
  }
}

# Find cohorts
cohort_data <- identify_cohorts(processed_lengths, length_columns)

if (nrow(cohort_data) > 0) {
  # Visualize cohorts
  ggplot(cohort_data, aes(x = cohort_length, y = cohort_strength)) +
    geom_point(alpha = 0.6, size = 2) +
    geom_smooth(method = "loess", se = TRUE) +
    geom_vline(xintercept = 12, color = "red", linetype = "dashed") +
    labs(
      title = "Identified Cohorts in Length Frequency Data",
      x = "Cohort Length (cm)",
      y = "Cohort Strength",
      caption = "Red line indicates juvenile limit"
    ) +
    theme_minimal()
}
```

## Quality Control

### Data Validation

```{r eval=FALSE}
# Validate juvenile analysis results
validate_juvenile_analysis <- function(results) {
  validation <- list(
    total_records = nrow(results),
    
    # Check for reasonable percentages
    invalid_number_pct = sum(results$perc_juv_number < 0 | results$perc_juv_number > 100, na.rm = TRUE),
    invalid_weight_pct = sum(results$perc_juv_weight < 0 | results$perc_juv_weight > 100, na.rm = TRUE),
    
    # Check for missing values
    missing_number_pct = sum(is.na(results$perc_juv_number)),
    missing_weight_pct = sum(is.na(results$perc_juv_weight)),
    
    # Check for zero totals
    zero_total_number = sum(results$total_number == 0, na.rm = TRUE),
    zero_total_weight = sum(results$total_weight == 0, na.rm = TRUE),
    
    # Summary statistics
    avg_juv_number = mean(results$perc_juv_number, na.rm = TRUE),
    avg_juv_weight = mean(results$perc_juv_weight, na.rm = TRUE),
    
    # Correlation between number and weight percentages
    correlation = cor(results$perc_juv_number, results$perc_juv_weight, use = "complete.obs")
  )
  
  return(validation)
}

# Validate results
validation_results <- validate_juvenile_analysis(juvenile_results)
print(validation_results)

# Flag problematic records
problematic_records <- juvenile_results %>%
  filter(
    perc_juv_number < 0 | perc_juv_number > 100 |
    perc_juv_weight < 0 | perc_juv_weight > 100 |
    total_number == 0
  )

if (nrow(problematic_records) > 0) {
  warning("Found ", nrow(problematic_records), " problematic records")
  print(head(problematic_records))
}
```

### Outlier Detection

```{r eval=FALSE}
# Detect outliers in juvenile percentages
detect_outliers <- function(data, method = "iqr", threshold = 1.5) {
  if (method == "iqr") {
    Q1 <- quantile(data, 0.25, na.rm = TRUE)
    Q3 <- quantile(data, 0.75, na.rm = TRUE) 
    IQR <- Q3 - Q1
    
    lower_bound <- Q1 - threshold * IQR
    upper_bound <- Q3 + threshold * IQR
    
    outliers <- which(data < lower_bound | data > upper_bound)
  } else if (method == "zscore") {
    z_scores <- abs(scale(data))
    outliers <- which(z_scores > threshold)
  }
  
  return(outliers)
}

# Find outliers
number_outliers <- detect_outliers(juvenile_results$perc_juv_number)
weight_outliers <- detect_outliers(juvenile_results$perc_juv_weight)

cat("Number percentage outliers:", length(number_outliers), "\n")
cat("Weight percentage outliers:", length(weight_outliers), "\n")

# Visualize outliers
juvenile_results$outlier_type <- "Normal"
juvenile_results$outlier_type[number_outliers] <- "Number Outlier"
juvenile_results$outlier_type[weight_outliers] <- "Weight Outlier"
juvenile_results$outlier_type[intersect(number_outliers, weight_outliers)] <- "Both Outliers"

ggplot(juvenile_results, aes(x = perc_juv_number, y = perc_juv_weight, color = outlier_type)) +
  geom_point(alpha = 0.7) +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "gray") +
  labs(
    title = "Juvenile Percentage: Number vs Weight",
    x = "Juvenile % by Number",
    y = "Juvenile % by Weight", 
    color = "Outlier Type"
  ) +
  theme_minimal()
```

## Integration with Management

### Regulatory Compliance

```{r eval=FALSE}
# Check compliance with juvenile limits
check_compliance <- function(data, max_juvenile_pct = 10) {
  data$compliant <- data$perc_juv_number <= max_juvenile_pct
  
  compliance_summary <- data %>%
    group_by(compliant) %>%
    summarise(
      hauls = n(),
      avg_juvenile_pct = mean(perc_juv_number, na.rm = TRUE),
      total_catch = sum(total_weight, na.rm = TRUE),
      .groups = "drop"
    ) %>%
    mutate(
      compliance_status = ifelse(compliant, "Compliant", "Non-compliant"),
      percentage_hauls = round(hauls / sum(hauls) * 100, 1)
    )
  
  return(compliance_summary)
}

# Check compliance
compliance_results <- check_compliance(juvenile_results, max_juvenile_pct = 10)
print(compliance_results)
```

### Recommendation System

```{r eval=FALSE}
# Generate management recommendations
generate_recommendations <- function(juvenile_data, spatial_data = NULL) {
  avg_juvenile_pct <- mean(juvenile_data$perc_juv_number, na.rm = TRUE)
  
  recommendations <- list()
  
  # Overall juvenile level
  if (avg_juvenile_pct > 20) {
    recommendations$overall <- "HIGH CONCERN: Average juvenile percentage exceeds 20%. Consider temporary fishing restrictions."
  } else if (avg_juvenile_pct > 10) {
    recommendations$overall <- "MODERATE CONCERN: Monitor juvenile levels closely. Implement selective fishing practices."
  } else {
    recommendations$overall <- "ACCEPTABLE: Current juvenile levels are within acceptable range."
  }
  
  # Temporal patterns
  if (!is.null(juvenile_data$date)) {
    recent_data <- juvenile_data[juvenile_data$date >= (max(juvenile_data$date) - 30), ]
    if (nrow(recent_data) > 0) {
      recent_avg <- mean(recent_data$perc_juv_number, na.rm = TRUE)
      if (recent_avg > avg_juvenile_pct * 1.5) {
        recommendations$temporal <- "Recent increase in juvenile capture detected. Investigate causes."
      }
    }
  }
  
  # Spatial patterns
  if (!is.null(spatial_data)) {
    nearshore_data <- spatial_data[spatial_data$dc < 10, ]
    if (nrow(nearshore_data) > 0) {
      nearshore_juv <- mean(nearshore_data$perc_juv_number, na.rm = TRUE)
      if (nearshore_juv > 15) {
        recommendations$spatial <- "High juvenile capture in nearshore areas. Consider coastal fishing restrictions."
      }
    }
  }
  
  return(recommendations)
}

# Generate recommendations
recommendations <- generate_recommendations(juvenile_results, spatial_data)
cat("Management Recommendations:\n")
for (i in seq_along(recommendations)) {
  cat(names(recommendations)[i], ":", recommendations[[i]], "\n")
}
```

## Conclusion

Tivy's juvenile analysis capabilities provide:

1. **Flexible juvenile definitions** with customizable size limits
2. **Length-weight integration** for biomass-based analysis  
3. **Temporal and spatial pattern analysis** for management insights
4. **Quality control tools** for data validation
5. **Visualization functions** for clear communication of results

These tools support evidence-based fisheries management by providing comprehensive juvenile fish analysis capabilities tailored for Peruvian fisheries data.

## Best Practices

### 1. Parameter Selection
- Use species-specific length-weight parameters when available
- Validate parameters against known data before analysis
- Consider seasonal variations in growth parameters

### 2. Juvenile Thresholds
- Base juvenile limits on biological criteria (size at maturity)
- Consider legal minimum sizes in management context
- Account for gear selectivity effects

### 3. Data Quality
- Always validate length frequency data before analysis
- Check for reasonable total numbers and weights
- Identify and investigate outliers

### 4. Interpretation
- Consider both number and weight-based percentages
- Account for temporal and spatial patterns
- Integrate with other fisheries indicators

## Example Workflow

```{r eval=FALSE}
# Complete juvenile analysis workflow
library(Tivy)

# 1. Process length frequency data
processed_lengths <- process_length(raw_length_data)

# 2. Apply catch weighting
weighted_data <- apply_catch_weighting(
  data = processed_lengths,
  length_cols = find_columns_by_pattern(processed_lengths, "^[0-9]"),
  catch_col = "total_catch",
  a = 0.0048,  # Species-specific parameters
  b = 3.067
)

# 3. Calculate juvenile percentages
juvenile_analysis <- summarize_juveniles_by_group(
  data = weighted_data,
  group_cols = c("date", "fishing_zone"),
  length_cols = find_columns_by_pattern(weighted_data, "weighted_"),
  juvenile_limit = 12
)

# 4. Validate results
validation <- validate_juvenile_analysis(juvenile_analysis)
print(validation)

# 5. Create visualizations
juvenile_plot <- plot_juvenile_analysis(
  data = weighted_data,
  x_var = "date",
  length_cols = find_columns_by_pattern(weighted_data, "weighted_"),
  plot_type = "mixed",
  reference_line = 10  # Management target
)

print(juvenile_plot)

# 6. Generate management recommendations
recommendations <- generate_recommendations(juvenile_analysis)
print(recommendations)
```

## Further Reading

- See the spatial analysis vignette for combining juvenile and spatial patterns
- Check the data processing vignette for data preparation workflows  
- Refer to the main introduction for overview of all package capabilities
- Consult fisheries management literature for interpretation guidelines